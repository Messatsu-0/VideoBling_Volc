name: Deploy to ECS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy (branch/tag/commit)"
        required: false
        default: "main"

permissions:
  contents: read

concurrency:
  group: videobling-ecs-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on:
      - self-hosted
      - Linux
      - X64
    timeout-minutes: 30
    steps:
      - name: Deploy on ECS (self-hosted runner)
        env:
          ECS_WORKDIR: ${{ vars.ECS_WORKDIR }}
          DEPLOY_REF: ${{ github.event.inputs.ref || github.ref_name }}
        run: |
          set -euo pipefail
          WORKDIR="${ECS_WORKDIR:-/opt/videobling}"
          REF="${DEPLOY_REF:-main}"
          if [ ! -d "${WORKDIR}/.git" ]; then
            echo "Missing deployment repository: ${WORKDIR}"
            exit 1
          fi
          cd "${WORKDIR}"
          ./scripts/update_prod.sh "${REF}"
